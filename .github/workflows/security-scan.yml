name: Reusable Security Scan (Trivy)

on:
  workflow_call:
    inputs:
      scan_fs:
        type: boolean
        default: true
      scan_iac:
        type: boolean
        default: true
      scan_secrets:
        type: boolean
        default: true

      # Docker image scanning
      scan_docker:
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/trivy
          key: trivy-db-${{ runner.os }}

      - name: Install Trivy CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl gnupg lsb-release
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Download Trivy HTML template
        run: |
          curl -L -o html.tpl https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl

      # ✅ FS Scan
      - name: Trivy FS Scan (HTML)
        if: ${{ inputs.scan_fs }}
        run: |
          trivy fs . \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-fs-report.html

      # ✅ IaC Scan
      - name: Trivy IaC Scan (HTML)
        if: ${{ inputs.scan_iac }}
        run: |
          trivy config . \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-iac-report.html

      # ✅ Secrets Scan
      - name: Trivy Secrets Scan (HTML)
        if: ${{ inputs.scan_secrets }}
        run: |
          trivy fs . \
            --scanners secret \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-secrets-report.html

      - name: Create empty .env for Docker build
        if: ${{ inputs.scan_docker }}
        run: |
          echo "# dummy env for build" > .env 

      # ✅ Docker Image Build for Scan (local)
      - name: Set up Docker Buildx
        if: ${{ inputs.scan_docker }}
        uses: docker/setup-buildx-action@v3

      - name: Build image locally for scanning (no push)
        if: ${{ inputs.scan_docker }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: local-scan:${{ github.run_number }}

      # ✅ Docker Image Scan
      - name: Trivy Docker Image Scan (HTML)
        if: ${{ inputs.scan_docker }}
        run: |
          trivy image local-scan:${{ github.run_number }} \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-image-report.html

      # ✅ Block only on CRITICAL
      - name: Trivy Block (fail only on CRITICAL)
        if: ${{ inputs.scan_docker }}
        run: |
          trivy image local-scan:${{ github.run_number }} \
            --severity CRITICAL \
            --exit-code 1

      # ✅ Upload reports
      - name: Upload Security Reports (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            trivy-*-report.html