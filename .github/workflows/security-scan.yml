name: Reusable Security Scan (Trivy)

on:
  workflow_call:
    inputs:
      application_name:
        required: true
        type: string
      scan_fs:
        type: boolean
        default: true
      scan_iac:
        type: boolean
        default: true
      scan_secrets:
        type: boolean
        default: true
      scan_deps:
        type: boolean
        default: true
      scan_docker:
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Cache Trivy DB
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: /home/runner/.cache/trivy
          key: trivy-db-${{ runner.os }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Install tools
      - name: Install Trivy & jq
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl gnupg lsb-release jq
          wget -qO- https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -cs) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Download Trivy HTML template
        run: |
          curl -L -o html.tpl \
          https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Dependency Scan (HTML)
      - name: Trivy Dependency Scan (HTML)
        if: ${{ inputs.scan_deps }}
        run: |
          trivy fs . \
            --scanners vuln \
            --vuln-type library \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-deps-report.html

      # Dependency Scan (JSON â†’ used for counts)
      - name: Trivy Dependency Scan (JSON)
        if: ${{ inputs.scan_deps }}
        run: |
          trivy fs . \
            --scanners vuln \
            --vuln-type library \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format json \
            -o trivy-report.json

      # Block only if CRITICAL dependency found
      - name: Trivy Dependency Block (CRITICAL)
        if: ${{ inputs.scan_deps }}
        run: |
          trivy fs . \
            --scanners vuln \
            --vuln-type library \
            --severity CRITICAL \
            --exit-code 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # FS Scan
      - name: Trivy FS Scan (HTML)
        if: ${{ inputs.scan_fs }}
        run: |
          trivy fs . \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-fs-report.html

      # IaC Scan
      - name: Trivy IaC Scan (HTML)
        if: ${{ inputs.scan_iac }}
        run: |
          trivy config . \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-iac-report.html

      # Secrets Scan
      - name: Trivy Secrets Scan (HTML)
        if: ${{ inputs.scan_secrets }}
        run: |
          trivy fs . \
            --scanners secret \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-secrets-report.html

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Docker Scan
      - name: Create empty .env
        if: ${{ inputs.scan_docker }}
        run: echo "# dummy env" > .env

      - name: Set up Docker Buildx
        if: ${{ inputs.scan_docker }}
        uses: docker/setup-buildx-action@v3

      - name: Build image locally for scan
        if: ${{ inputs.scan_docker }}
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: local-scan:${{ github.run_number }}

      - name: Trivy Docker Image Scan (HTML)
        if: ${{ inputs.scan_docker }}
        run: |
          trivy image local-scan:${{ github.run_number }} \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            --format template \
            --template "@html.tpl" \
            -o trivy-image-report.html

      - name: Trivy Docker Block (CRITICAL)
        if: ${{ inputs.scan_docker }}
        run: |
          trivy image local-scan:${{ github.run_number }} \
            --severity CRITICAL \
            --exit-code 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Extract vulnerability counts (for Teams)
      - name: Extract vulnerability counts
        if: failure()
        run: |
          CRITICAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-report.json)
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-report.json)
          MEDIUM=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-report.json)
          LOW=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-report.json)

          echo "CRITICAL=$CRITICAL" >> $GITHUB_ENV
          echo "HIGH=$HIGH" >> $GITHUB_ENV
          echo "MEDIUM=$MEDIUM" >> $GITHUB_ENV
          echo "LOW=$LOW" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload reports
      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            trivy-*-report.html

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Teams Notification
      - name: Notify Teams (Security Scan Failed)
        if: failure()
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg workflow "$GITHUB_WORKFLOW" \
            --arg run_number "$GITHUB_RUN_NUMBER" \
            --arg critical "$CRITICAL" \
            --arg high "$HIGH" \
            --arg medium "$MEDIUM" \
            --arg low "$LOW" \
            --arg url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            '{
              "type": "message",
              "attachments": [
                {
                  "contentType": "application/vnd.microsoft.card.adaptive",
                  "content": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "type": "AdaptiveCard",
                    "version": "1.5",
                    "body": [
                      {
                        "type": "TextBlock",
                        "text": "ðŸš¨ Security Scan Failed",
                        "weight": "Bolder",
                        "size": "Large",
                        "color": "Attention"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "Repository", "value": $repo },
                          { "title": "Branch", "value": $branch },
                          { "title": "Workflow", "value": $workflow },
                          { "title": "Run #", "value": $run_number }
                        ]
                      },
                      {
                        "type": "TextBlock",
                        "text": "ðŸ“Š Vulnerability Summary",
                        "weight": "Bolder"
                      },
                      {
                        "type": "FactSet",
                        "facts": [
                          { "title": "CRITICAL", "value": $critical },
                          { "title": "HIGH", "value": $high },
                          { "title": "MEDIUM", "value": $medium },
                          { "title": "LOW", "value": $low }
                        ]
                      }
                    ],
                    "actions": [
                      {
                        "type": "Action.OpenUrl",
                        "title": "ðŸ”— Open GitHub Run",
                        "url": $url
                      }
                    ]
                  }
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -d "$payload" \
               "$TEAMS_WEBHOOK_URL"
